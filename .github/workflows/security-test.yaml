name: DevSecOps Scan (Dual Engine)

on: [push, pull_request]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: Security Audit
    permissions:
      contents: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------------
      # 1. SECRET SCAN (Gitleaks)
      # -----------------------------------------------------------
      - name: Run Gitleaks
        run: |
          curl -sS -L https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xf gitleaks.tar.gz gitleaks
          chmod +x gitleaks
          ./gitleaks detect -v --source . --report-path gitleaks-report.json --report-format json || true

      # -----------------------------------------------------------
      # 2. SAST PART A: BANDIT (The Heavy Hitter)
      # -----------------------------------------------------------
      - name: Run Bandit (Python Security)
        run: |
          pip install bandit
          # -r: recursive, -f json: format, -o: output
          # || true prevents pipeline failure
          bandit -r . -f json -o bandit-report.json || true

      # -----------------------------------------------------------
      # 3. SAST PART B: SEMGREP (Modern Rules)
      # -----------------------------------------------------------
      - name: Run Semgrep
        run: |
          pip install semgrep
          # We revert to 'p/default' + 'p/security-audit' for broad coverage
          semgrep scan --config=p/default --config=p/security-audit --json -o semgrep-report.json || true

      # -----------------------------------------------------------
      # 4. SCA SCAN (Trivy)
      # -----------------------------------------------------------
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
      
      - name: Trivy Scan
        run: |
          trivy fs . --format json --output trivy-report.json --exit-code 0

      # -----------------------------------------------------------
      # 5. GENERATE SMART DASHBOARD
      # -----------------------------------------------------------
      - name: Generate Dashboard
        if: always()
        shell: python
        run: |
          import json
          import os

          summary_content = "# ðŸ›¡ï¸ Security Scan Report\n\n"
          
          # Initialize data
          gitleaks_data = []
          semgrep_data = []
          bandit_data = []
          trivy_data = []

          # --- LOAD DATA ---
          if os.path.exists("gitleaks-report.json"):
              try:
                  with open("gitleaks-report.json") as f:
                      gitleaks_data = json.load(f)
              except: pass

          if os.path.exists("semgrep-report.json"):
              try:
                  with open("semgrep-report.json") as f:
                      semgrep_data = json.load(f).get('results', [])
              except: pass

          if os.path.exists("bandit-report.json"):
              try:
                  with open("bandit-report.json") as f:
                      data = json.load(f)
                      bandit_data = data.get('results', [])
              except: pass

          if os.path.exists("trivy-report.json"):
              try:
                  with open("trivy-report.json") as f:
                      data = json.load(f)
                      for result in data.get('Results', []):
                          for v in result.get('Vulnerabilities', []):
                              trivy_data.append({
                                  'pkg': v.get('PkgName', 'unknown'),
                                  'title': v.get('Title', 'No description available'),
                                  'severity': v.get('Severity', 'UNKNOWN'),
                                  'id': v.get('VulnerabilityID', 'unknown')
                              })
              except: pass

          # --- COMBINE & CLEAN SAST ---
          # Logic: If Semgrep finds an ERROR on file:line, ignore WARNINGs on same file:line
          sast_findings = []
          error_locations = set()

          # 1. Process Semgrep Errors first to build exclusion list
          for s in semgrep_data:
              sev = s.get('extra', {}).get('severity', 'UNKNOWN')
              if sev == "ERROR":
                  path = s.get('path', '?')
                  line = s.get('start', {}).get('line', '?')
                  error_locations.add(f"{path}:{line}")

          # 2. Add Semgrep Findings (Skipping Warnings if Error exists)
          for s in semgrep_data:
              path = s.get('path', '?')
              line = s.get('start', {}).get('line', '?')
              sev = s.get('extra', {}).get('severity', 'UNKNOWN')
              rule_id = s.get('check_id', '?').split('.')[-1] # Short name
              msg = s.get('extra', {}).get('message', '').split('.')[0] # Short msg
              
              # Skip WARNING if ERROR exists on same line
              if sev != "ERROR" and f"{path}:{line}" in error_locations:
                  continue

              icon = "ðŸ”´" if sev == "ERROR" else "ðŸŸ " # Fixed Typo
              sast_findings.append({
                  'tool': 'Semgrep',
                  'icon': icon,
                  'severity': sev,
                  'file': path,
                  'line': line,
                  'rule': rule_id,
                  'msg': msg
              })

          # 3. Add Bandit Findings
          for b in bandit_data:
              sev = b.get('issue_severity', 'MEDIUM')
              icon = "ðŸ”´" if sev == "HIGH" else "ðŸŸ "
              sast_findings.append({
                  'tool': 'Bandit',
                  'icon': icon,
                  'severity': sev,
                  'file': b.get('filename', '?'),
                  'line': b.get('line_number', '?'),
                  'rule': b.get('test_id', '?'),
                  'msg': b.get('issue_text', '?')
              })

          # --- BUILD HEADER ---
          gl_icon = "ðŸ”´" if len(gitleaks_data) > 0 else "âœ…"
          sast_icon = "ðŸ”´" if any(f['icon'] == "ðŸ”´" for f in sast_findings) else "âœ…"
          tr_icon = "ðŸŸ " if len(trivy_data) > 0 else "âœ…"

          summary_content += f"""
          | Category | Status | Issues |
          | :--- | :--- | :---: |
          | **Secrets** | {gl_icon} | {len(gitleaks_data)} |
          | **Code (SAST)** | {sast_icon} | {len(sast_findings)} |
          | **Deps (SCA)** | {tr_icon} | {len(trivy_data)} |
          
          ---
          """

          # --- SECTIONS ---

          # GITLEAKS
          if gitleaks_data:
              summary_content += f"""
          <details><summary><strong>ðŸ”» Secrets Details ({len(gitleaks_data)})</strong></summary>
          
          | Severity | File | Line | Variable |
          | :--- | :--- | :--- | :--- |
          """
              for s in gitleaks_data:
                  raw_match = s.get('Match', '')
                  safe_match = (raw_match[:20] + '...') if len(raw_match) > 20 else raw_match
                  safe_match = safe_match.replace('|', '\|')
                  summary_content += f"| **ðŸ”´ CRITICAL** | `{s.get('File', '?')}` | {s.get('StartLine', '?')} | `{safe_match}` |\n"
              summary_content += "</details>\n\n"

          # SAST (Combined)
          if sast_findings:
              summary_content += f"""
          <details><summary><strong>ðŸ”» Code Issues ({len(sast_findings)})</strong></summary>
          
          | Tool | Severity | File : Line | Rule Name | Message |
          | :--- | :--- | :--- | :--- | :--- |
          """
              for f in sast_findings:
                  summary_content += f"| {f['tool']} | **{f['icon']} {f['severity']}** | `{f['file']}:{f['line']}` | `{f['rule']}` | {f['msg']} |\n"
              
              summary_content += "</details>\n\n"

          # TRIVY
          if trivy_data:
              summary_content += f"""
          <details><summary><strong>ðŸ”» Vulnerable Dependencies ({len(trivy_data)})</strong></summary>
          
          | Severity | Package | Vuln Name | ID |
          | :--- | :--- | :--- | :--- |
          """
              for t in trivy_data:
                  icon = "ðŸ”´" if t['severity'] in ["CRITICAL", "HIGH"] else "ðŸŸ "
                  title = t['title'].replace('|', '-')
                  summary_content += f"| **{icon} {t['severity']}** | `{t['pkg']}` | {title} | {t['id']} |\n"
              summary_content += "</details>\n"

          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(summary_content)
